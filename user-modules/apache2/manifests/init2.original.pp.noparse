class apache2 {

	define site( $sitedomain = "", $documentroot = "" ) {
		include apache
		if $sitedomain == "" {
			$vhost_domain = $name
		} else {
			$vhost_domain = $sitedomain
		}
		if $documentroot == "" {
			$vhost_root = "/var/www/${name}"
		} else {
			$vhost_root = $documentroot
		}

		file { "/etc/apache2/sites-available/${vhost_domain}.
			conf":
				content => template("apache/vhost.erb"),
				require => File["/etc/apache2/conf.d/name-basedvhosts.conf"],
				notify => Exec["enable-${vhost_domain}-vhost"],
		}
		exec { "enable-${vhost_domain}-vhost":
			command => "/usr/sbin/a2ensite ${vhost_domain}.conf",
			require => [ File["/etc/apache2/sitesavailable/${vhost_domain}.conf"], 
			Package["apache2-mpm-prefork"] ],
			refreshonly => true,
			notify => Service["apache2"],
		}
	}

	package {
	  "apache2" : 
	    ensure => present,
            before => File["/etc/apache2/apache2.conf"]
	}
	service {
	  "apache2":
	    ensure    => true,
	    enable    => true,
            subscribe => File["/etc/apache2/apache2.conf"]
	}
	file {
	  "/etc/apache2/apache2.conf":
	    source  => "puppet:///modules/apache2/apache2.conf",
	    mode    => 644,
	    owner   => root,
	    group   => root;
	  "/etc/apache2/sites-enabled/advance2.conf":
	    source  => "puppet:///modules/apache2/advance2.conf",
	    owner   => root,
	    group   => root,
	    notify  => Service["apache2"],
	    require => Package["apache2"];
	}

}
